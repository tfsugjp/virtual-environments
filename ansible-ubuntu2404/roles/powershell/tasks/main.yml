---
# powershell role - Phase 3: PowerShell and modules

- name: Install vital APT packages
  ansible.builtin.shell: "{{ installer_script_folder }}/install-apt-vital.sh"
  environment:
    DEBIAN_FRONTEND: noninteractive
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
  become: true
  register: apt_vital_result
  changed_when: "'installed' in apt_vital_result.stdout.lower()"

- name: Install PowerShell
  ansible.builtin.shell: "{{ installer_script_folder }}/install-powershell.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
  become: true
  register: pwsh_install_result
  changed_when: "'Installing' in pwsh_install_result.stdout or 'installed' in pwsh_install_result.stdout.lower()"

- name: Verify PowerShell installation
  ansible.builtin.command: pwsh --version
  register: pwsh_version_check
  changed_when: false
  failed_when: pwsh_version_check.rc != 0

- name: Display PowerShell version
  ansible.builtin.debug:
    msg: "PowerShell installed: {{ pwsh_version_check.stdout }}"

- name: Install PowerShell modules
  ansible.builtin.shell: "pwsh -f {{ item }}"
  loop:
    - "{{ installer_script_folder }}/Install-PowerShellModules.ps1"
    - "{{ installer_script_folder }}/Install-PowerShellAzModules.ps1"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
  become: true
  register: pwsh_modules_result
  changed_when: "'Installing' in pwsh_modules_result.stdout"

- name: Display powershell role completion
  ansible.builtin.debug:
    msg: "PowerShell and modules installation completed"
