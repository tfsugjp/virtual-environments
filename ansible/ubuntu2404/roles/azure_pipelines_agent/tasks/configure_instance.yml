---
# =============================================================================
# Configure a single Azure Pipelines Agent instance
# =============================================================================
# Called from main.yml via loop.  Expects:
#   _instance              – dict with at least 'name', optionally 'pool'
#   _azp_resolved_version  – target version string
#   _azp_tarball_path      – path to downloaded tarball
#   All azp_* defaults

- name: "{{ _instance.name }} | Set instance variables"
  ansible.builtin.set_fact:
    _inst_dir: "{{ azp_agent_base_dir }}/{{ _instance.name }}"
    _inst_pool: "{{ _instance.pool | default(azp_pool) }}"
    _inst_service_script: "{{ azp_agent_base_dir }}/{{ _instance.name }}/svc.sh"
    _inst_agent_file: "{{ azp_agent_base_dir }}/{{ _instance.name }}/.agent"
    _inst_version_marker: "{{ azp_agent_base_dir }}/{{ _instance.name }}/.ansible_agent_version"

# ---- Check current state ------------------------------------------------

- name: "{{ _instance.name }} | Check for existing .agent file"
  ansible.builtin.stat:
    path: "{{ _inst_agent_file }}"
  register: _inst_agent_stat

- name: "{{ _instance.name }} | Read current agent version"
  when: _inst_agent_stat.stat.exists | default(false)
  block:
    - name: "{{ _instance.name }} | Slurp .agent file"
      ansible.builtin.slurp:
        src: "{{ _inst_agent_file }}"
      register: _inst_agent_content

    - name: "{{ _instance.name }} | Parse current version from .agent JSON"
      ansible.builtin.set_fact:
        _inst_current_version: "{{ (_inst_agent_content.content | b64decode | from_json).agentVersion | default('') }}"

- name: "{{ _instance.name }} | Default current version to empty if not installed"
  ansible.builtin.set_fact:
    _inst_current_version: ""
  when: not (_inst_agent_stat.stat.exists | default(false))

- name: "{{ _instance.name }} | Determine if install/update is needed"
  ansible.builtin.set_fact:
    _inst_needs_update: >-
      {{
        (azp_force_reinstall | default(false) | bool)
        or (_inst_current_version != _azp_resolved_version)
      }}

- name: "{{ _instance.name }} | Display version comparison"
  ansible.builtin.debug:
    msg: >-
      Instance '{{ _instance.name }}':
      current={{ _inst_current_version | default('(none)') }},
      target={{ _azp_resolved_version }},
      force_reinstall={{ azp_force_reinstall | default(false) | bool }},
      action={{
        'force reinstall' if (azp_force_reinstall | default(false) | bool)
        else ('install/update' if (_inst_needs_update | bool) else 'skip (up-to-date)')
      }}

# ---- Skip if already at target version ----------------------------------

- name: "{{ _instance.name }} | Install or update agent"
  when: _inst_needs_update | bool
  block:
    # ---- Stop existing service (update path) ---------------------------

    - name: "{{ _instance.name }} | Check if svc.sh exists"
      ansible.builtin.stat:
        path: "{{ _inst_service_script }}"
      register: _inst_svc_stat

    - name: "{{ _instance.name }} | Stop agent service (update)"
      ansible.builtin.shell: |
        cd {{ _inst_dir }}
        ./svc.sh stop || true
      become: true
      when:
        - _inst_current_version | length > 0
        - _inst_svc_stat.stat.exists | default(false)
      changed_when: true

    - name: "{{ _instance.name }} | Uninstall agent service (update)"
      ansible.builtin.shell: |
        cd {{ _inst_dir }}
        ./svc.sh uninstall || true
      become: true
      when:
        - _inst_current_version | length > 0
        - _inst_svc_stat.stat.exists | default(false)
      changed_when: true

    - name: "{{ _instance.name }} | Unconfigure existing agent (update)"
      ansible.builtin.shell: |
        cd {{ _inst_dir }}
        ./config.sh remove \
          --auth sp \
          --clientid {{ azp_client_id }} \
          --tenantid {{ azp_tenant_id }} \
          --clientsecret {{ azp_client_secret }}
      become: true
      become_user: "{{ azp_agent_user }}"
      no_log: true
      when:
        - _inst_current_version | length > 0
        - _inst_agent_stat.stat.exists | default(false)
      changed_when: true
      failed_when: false   # Best-effort removal; fresh install will follow

    # ---- Create user & directory ---------------------------------------

    - name: "{{ _instance.name }} | Create agent system user"
      ansible.builtin.user:
        name: "{{ azp_agent_user }}"
        system: true
        create_home: true
        home: "/home/{{ azp_agent_user }}"
        shell: /bin/bash
        state: present
      become: true

    - name: "{{ _instance.name }} | Add agent user to docker group"
      ansible.builtin.user:
        name: "{{ azp_agent_user }}"
        groups: docker
        append: true
      become: true
      failed_when: false   # docker group may not exist yet

    - name: "{{ _instance.name }} | Create instance directory"
      ansible.builtin.file:
        path: "{{ _inst_dir }}"
        state: directory
        owner: "{{ azp_agent_user }}"
        group: "{{ azp_agent_user }}"
        mode: '0755'
      become: true

    # ---- Extract tarball -----------------------------------------------

    - name: "{{ _instance.name }} | Extract agent tarball"
      ansible.builtin.unarchive:
        src: "{{ _azp_tarball_path }}"
        dest: "{{ _inst_dir }}"
        remote_src: true
        owner: "{{ azp_agent_user }}"
        group: "{{ azp_agent_user }}"
        extra_opts:
          - "--no-same-owner"
      become: true

    # ---- Configure agent -----------------------------------------------

    - name: "{{ _instance.name }} | Run config.sh"
      ansible.builtin.shell: |
        cd {{ _inst_dir }}
        ./config.sh --unattended \
          --url {{ azp_url }} \
          --auth {{ azp_auth_type }} \
          --clientid {{ azp_client_id }} \
          --tenantid {{ azp_tenant_id }} \
          --clientsecret {{ azp_client_secret }} \
          --pool '{{ _inst_pool }}' \
          --agent '{{ _instance.name }}' \
          --work '{{ azp_agent_work_dir }}' \
          --acceptTeeEula \
          {{ '--replace' if (azp_replace_existing | bool) else '' }}
      become: true
      become_user: "{{ azp_agent_user }}"
      no_log: true
      changed_when: true

    # ---- Install and start systemd service ----------------------------

    - name: "{{ _instance.name }} | Install agent as systemd service"
      ansible.builtin.shell: |
        cd {{ _inst_dir }}
        ./svc.sh install {{ azp_agent_user }}
      become: true
      changed_when: true

    - name: "{{ _instance.name }} | Start agent service"
      ansible.builtin.shell: |
        cd {{ _inst_dir }}
        ./svc.sh start
      become: true
      changed_when: true

    # ---- Write version marker ------------------------------------------

    - name: "{{ _instance.name }} | Write version marker"
      ansible.builtin.copy:
        content: "{{ _azp_resolved_version }}"
        dest: "{{ _inst_version_marker }}"
        owner: "{{ azp_agent_user }}"
        group: "{{ azp_agent_user }}"
        mode: '0644'
      become: true

# ---- Verify service status (always) -----------------------------------

- name: "{{ _instance.name }} | Verify agent service status"
  ansible.builtin.shell: |
    cd {{ _inst_dir }}
    ./svc.sh status
  become: true
  register: _inst_svc_status
  changed_when: false
  failed_when: false

- name: "{{ _instance.name }} | Display service status"
  ansible.builtin.debug:
    msg: "{{ _inst_svc_status.stdout_lines | default(['Service status unknown']) }}"
