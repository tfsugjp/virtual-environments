---
# development_tools role - Phase 4: Development tools installation
# This is the largest role with 50+ tools

- name: Cleanup temp/keyring files to make installers rerunnable
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    # AWS tools installers can prompt if these exist from a previous failed run.
    - /tmp/aws
    - /tmp/install
    - /tmp/aws-sam-cli
    - /tmp/aws-sam-cli-src
    # AWS SAM CLI unzip can prompt if /tmp/dist exists from a previous run.
    - /tmp/dist
    - /tmp/installers/aws
    - /tmp/installers/aws-sam-cli
    # kubectl installer can prompt (no /dev/tty) when overwriting keyring.
    - /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    - /etc/apt/sources.list.d/kubernetes.list
  become: true
  tags: ['cloud', 'containers']

- name: Make AWS CLI installer rerunnable (add --update)
  ansible.builtin.replace:
    path: "{{ installer_script_folder }}/install-aws-tools.sh"
    regexp: '^(\s*/tmp/aws/install\b(?!.*--update).*)$'
    replace: '\g<1> --update'
  become: true
  tags: ['cloud', 'containers']

- name: Make AWS SAM CLI unzip non-interactive (avoid prompts on reruns)
  ansible.builtin.replace:
    path: "{{ installer_script_folder }}/install-aws-tools.sh"
    regexp: '^(\s*)unzip\s+"\$aws_sam_cli_archive_path"\s+-d\s+/tmp\s*$'
    replace: '\g<1>unzip -o "$aws_sam_cli_archive_path" -d /tmp'
  become: true
  tags: ['cloud', 'containers']

- name: Make AWS SAM CLI installer rerunnable (add --update)
  ansible.builtin.replace:
    path: "{{ installer_script_folder }}/install-aws-tools.sh"
    regexp: '^(\s*/tmp/install\b(?!.*--update).*)$'
    replace: '\g<1> --update'
  become: true
  tags: ['cloud', 'containers']

- name: Install development tools (batch 1 - Cloud & Container)
  ansible.builtin.shell: "{{ item }}"
  loop:
    - "{{ installer_script_folder }}/install-azcopy.sh"
    - "{{ installer_script_folder }}/install-azure-cli.sh"
    - "{{ installer_script_folder }}/install-azure-devops-cli.sh"
    - "{{ installer_script_folder }}/install-bicep.sh"
    - "{{ installer_script_folder }}/install-aws-tools.sh"
    - "{{ installer_script_folder }}/install-container-tools.sh"
    - "{{ installer_script_folder }}/install-kubernetes-tools.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: cloud_tools_result
  changed_when: cloud_tools_result.rc == 0
  tags: ['cloud', 'containers']

- name: Install Ruby (native)
  ansible.builtin.include_tasks: ruby.yml
  when: not ansible_check_mode
  tags: ['languages', 'ruby']

- name: Make Swift installer symlink creation safe on reruns
  ansible.builtin.replace:
    path: "{{ installer_script_folder }}/install-swift.sh"
    regexp: '^(\s*)ln\s+-s\s+(".*?")\s+(/usr/local/(bin|lib)/\S+)\s*$'
    replace: '\g<1>ln -sf \g<2> \g<3>'
  become: true
  tags: ['compilers']

- name: Make Swift install directory replacement safe on reruns
  ansible.builtin.replace:
    path: "{{ installer_script_folder }}/install-swift.sh"
    regexp: '^(\s*)mv\s+"/tmp/\$\{swift_release_name\}"\s+\$SWIFT_INSTALL_ROOT\s*$'
    replace: |
      \g<1>rm -rf "$SWIFT_INSTALL_ROOT/${swift_release_name}"
      \g<1>mv "/tmp/${swift_release_name}" $SWIFT_INSTALL_ROOT
  become: true
  tags: ['compilers']

- name: Install development tools (batch 2 - Compilers)
  ansible.builtin.shell: "{{ item }}"
  loop:
    - "{{ installer_script_folder }}/install-clang.sh"
    - "{{ installer_script_folder }}/install-swift.sh"
    - "{{ installer_script_folder }}/install-gcc-compilers.sh"
    - "{{ installer_script_folder }}/install-gfortran.sh"
    - "{{ installer_script_folder }}/install-cmake.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: compilers_result
  changed_when: compilers_result.rc == 0
  tags: ['compilers']

- name: Make Java tools installer rerunnable (no interactive unzip / idempotent symlinks)
  ansible.builtin.replace:
    path: "{{ installer_script_folder }}/install-java-tools.sh"
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  loop:
    - regexp: '^(\s*)unzip\s+-qq\s+-d\s+/usr/share\s+"\$maven_archive_path"\s*$'
      replace: '\g<1>unzip -o -qq -d /usr/share "$maven_archive_path"'
    - regexp: '^(\s*)unzip\s+-qq\s+-d\s+/usr/share\s+"\$gradle_archive_path"\s*$'
      replace: '\g<1>unzip -o -qq -d /usr/share "$gradle_archive_path"'
    - regexp: '^(\s*)ln\s+-s\s+(/usr/share/apache-maven-\$\{?mavenVersion\}?/bin/mvn)\s+/usr/bin/mvn\s*$'
      replace: '\g<1>ln -sf \g<2> /usr/bin/mvn'
    - regexp: '^(\s*)ln\s+-s\s+(/usr/share/gradle-"\$\{?gradleLatestVersion\}?"/bin/gradle)\s+/usr/bin/gradle\s*$'
      replace: '\g<1>ln -sf \g<2> /usr/bin/gradle'
  loop_control:
    label: "{{ item.regexp }}"
  become: true
  tags: ['languages']

- name: Make Kotlin installer unzip non-interactive (avoid prompts on reruns)
  ansible.builtin.replace:
    path: "{{ installer_script_folder }}/install-kotlin.sh"
    regexp: '^(\s*)unzip\s+-qq\s+"\$archive_path"\s+-d\s+\$KOTLIN_ROOT\s*$'
    replace: '\g<1>unzip -o -qq "$archive_path" -d $KOTLIN_ROOT'
  become: true
  tags: ['languages']

- name: Install development tools (batch 3 - Languages - Part 1)
  ansible.builtin.shell: "{{ item }}"
  loop:
    - "{{ installer_script_folder }}/install-java-tools.sh"
    - "{{ installer_script_folder }}/install-rust.sh"
    - "{{ installer_script_folder }}/install-php.sh"
    - "{{ installer_script_folder }}/install-kotlin.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: languages_1_result
  changed_when: languages_1_result.rc == 0
  tags: ['languages']

- name: Install Haskell (native)
  ansible.builtin.include_tasks: haskell.yml
  when: not ansible_check_mode
  tags: ['languages', 'haskell']

- name: Install development tools (batch 4 - Languages - Part 2)
  ansible.builtin.shell: "{{ item }}"
  loop:
    - "{{ installer_script_folder }}/install-julia.sh"
    - "{{ installer_script_folder }}/install-nvm.sh"
    - "{{ installer_script_folder }}/install-nodejs.sh"
    - "{{ installer_script_folder }}/install-python.sh"
    - "{{ installer_script_folder }}/install-pypy.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: languages_2_result
  changed_when: languages_2_result.rc == 0
  tags: ['languages']

- name: Install development tools (batch 5 - Databases)
  ansible.builtin.shell: "{{ item }}"
  loop:
    - "{{ installer_script_folder }}/install-mysql.sh"
    - "{{ installer_script_folder }}/install-postgresql.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: databases_result
  changed_when: databases_result.rc == 0
  tags: ['databases']

- name: Install development tools (batch 6 - Web & Browsers)
  ansible.builtin.shell: "{{ item }}"
  loop:
    - "{{ installer_script_folder }}/install-apache.sh"
    - "{{ installer_script_folder }}/install-nginx.sh"
    - "{{ installer_script_folder }}/install-google-chrome.sh"
    - "{{ installer_script_folder }}/install-microsoft-edge.sh"
    - "{{ installer_script_folder }}/install-firefox.sh"
    - "{{ installer_script_folder }}/install-selenium.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: web_tools_result
  changed_when: web_tools_result.rc == 0
  tags: ['web', 'browsers']

- name: Install development tools (batch 7 - Build Tools)
  ansible.builtin.shell: "{{ item }}"
  loop:
    - "{{ installer_script_folder }}/install-bazel.sh"
    - "{{ installer_script_folder }}/install-packer.sh"
    - "{{ installer_script_folder }}/install-vcpkg.sh"
    - "{{ installer_script_folder }}/install-ninja.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: build_tools_result
  changed_when: build_tools_result.rc == 0
  tags: ['build_tools']

- name: Install development tools (batch 8 - Misc Tools)
  ansible.builtin.shell: "{{ item }}"
  loop:
    - "{{ installer_script_folder }}/install-apt-common.sh"
    - "{{ installer_script_folder }}/install-git.sh"
    - "{{ installer_script_folder }}/install-git-lfs.sh"
    - "{{ installer_script_folder }}/install-github-cli.sh"
    - "{{ installer_script_folder }}/install-google-cloud-cli.sh"
    - "{{ installer_script_folder }}/install-miniconda.sh"
    - "{{ installer_script_folder }}/install-android-sdk.sh"
    - "{{ installer_script_folder }}/install-pulumi.sh"
    - "{{ installer_script_folder }}/install-codeql-bundle.sh"
    - "{{ installer_script_folder }}/install-dotnetcore-sdk.sh"
    - "{{ installer_script_folder }}/install-yq.sh"
    - "{{ installer_script_folder }}/install-zstd.sh"
    - "{{ installer_script_folder }}/configure-dpkg.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: misc_tools_result
  changed_when: misc_tools_result.rc == 0
  tags: ['misc']

- name: Display development_tools completion
  ansible.builtin.debug:
    msg: "Development tools installation completed (50+ tools installed)"
