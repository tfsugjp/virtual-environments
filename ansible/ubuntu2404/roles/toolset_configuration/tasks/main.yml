---
# toolset_configuration role - Phase 6: Toolset configuration

- name: Find leftover extraction temp dirs
  ansible.builtin.find:
    paths: /tmp
    patterns:
      # Toolset installer extracts downloaded tarballs into deterministic temp dirs.
      # On reruns, `New-Item` fails if the dir already exists.
      # Keep this broad enough to cover x64/arm64 and future tools, but still scoped
      # to clearly-temporary folders created from tar.gz downloads.
      - '*-linux-*.tar.gz-temp-dir'
    file_type: directory
  become: true
  register: extraction_temp_dirs

- name: Remove leftover extraction temp dirs
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ extraction_temp_dirs.files }}"
  loop_control:
    label: "{{ item.path }}"
  become: true

- name: Install toolset
  ansible.builtin.shell: "pwsh -f {{ installer_script_folder }}/Install-Toolset.ps1"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
  become: true
  register: install_toolset_result
  changed_when: "'Installing' in install_toolset_result.stdout"

- name: Configure toolset
  ansible.builtin.shell: "pwsh -f {{ installer_script_folder }}/Configure-Toolset.ps1"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
  become: true
  register: configure_toolset_result
  changed_when: configure_toolset_result.rc == 0

- name: Install pipx packages
  ansible.builtin.shell: "{{ installer_script_folder }}/install-pipx-packages.sh"
  environment:
    HELPER_SCRIPTS: "{{ helper_script_folder }}"
    INSTALLER_SCRIPT_FOLDER: "{{ installer_script_folder }}"
  become: true
  register: pipx_result
  changed_when: "'Installing' in pipx_result.stdout or 'installed' in pipx_result.stdout.lower()"

- name: Display toolset_configuration completion
  ansible.builtin.debug:
    msg: "Toolset configuration completed"
